<div class="search-page">
  <!-- Loading Spinner -->
  @if (loading) {
    <app-loading-spinner message="Fetching contributor data..."></app-loading-spinner>
  }

  <!-- Default Search Hero â€” shown when no profile is loaded yet -->
  @if (!loading && !userProfile) {
    <div class="search-hero">
      <div class="search-hero-icon">
        <i class="fas fa-search"></i>
      </div>
      <h1 class="search-hero-title">Search Contributors</h1>
      <p class="search-hero-desc">
        Enter a GitHub username to view their issues and pull requests in C2SI projects.
      </p>
      <div class="search-input-group">
        <input
          type="text"
          class="search-input"
          placeholder="Enter GitHub username..."
          [(ngModel)]="username"
          (keyup.enter)="onSearch()"
        />
        <button class="search-btn" (click)="onSearch()" [disabled]="!username.trim()">
          <i class="fas fa-search"></i>
          <span>Search</span>
        </button>
      </div>
      @if (errorMessage) {
        <p class="hero-error">
          <i class="fas fa-exclamation-triangle"></i>
          {{ errorMessage }}
        </p>
      }
    </div>
  }

  <!-- Error Message (shown only after a profile was loaded previously) -->
  @if (errorMessage && !loading && userProfile) {
    <div class="error-container">
      <i class="fas fa-exclamation-triangle error-icon"></i>
      <p class="error-text">{{ errorMessage }}</p>
    </div>
  }

  <!-- Main Content -->
  @if (!loading && !errorMessage && userProfile) {
    <div class="content-wrapper">
      <!-- Sidebar: Profile Card -->
      <aside class="sidebar">
        <div class="profile-card">
          <img [src]="userProfile.avatar_url" alt="{{ userProfile.login }}'s avatar" class="profile-avatar" />
          <h2 class="profile-name">{{ userProfile.name || userProfile.login }}</h2>
          @if (userProfile.name) {
            <p class="profile-login">&#64;{{ userProfile.login }}</p>
          }
          @if (userProfile.bio) {
            <p class="profile-bio">{{ userProfile.bio }}</p>
          }
          <button (click)="openGitHubProfile(userProfile.html_url)" class="github-link-btn">
            <i class="fab fa-github"></i>
            <span>View on GitHub</span>
          </button>
          <!-- Profile Meta -->
          <div class="profile-meta">
            @if (userProfile.location) {
              <div class="meta-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{ userProfile.location }}</span>
              </div>
            }
            @if (memberSince) {
              <div class="meta-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Member since {{ memberSince }}</span>
              </div>
            }
            <div class="meta-item">
              <i class="fas fa-users"></i>
              <span>{{ userProfile.followers }} followers &middot; {{ userProfile.following }} following</span>
            </div>
          </div>
          <!-- Stats -->
          <div class="profile-stats">
            <div class="stat">
              <span class="stat-value">{{ issues.length }}</span>
              <span class="stat-label">Issues</span>
            </div>
            <div class="stat">
              <span class="stat-value">{{ pullRequests.length }}</span>
              <span class="stat-label">PRs</span>
            </div>
            <div class="stat">
              <span class="stat-value">{{ uniqueRepositories.length }}</span>
              <span class="stat-label">Repos</span>
            </div>
          </div>
          <!-- Open / Closed Breakdown -->
          <div class="breakdown-section">
            <h4 class="breakdown-title">Issues Breakdown</h4>
            <div class="breakdown-bar">
              <div class="bar-segment open" [style.width.%]="issues.length ? (openIssues / issues.length) * 100 : 0">
              </div>
              <div class="bar-segment closed" [style.width.%]="issues.length ? (closedIssues / issues.length) * 100 : 0">
              </div>
            </div>
            <div class="breakdown-legend">
              <span class="legend-item"><i class="fas fa-circle open-dot"></i> {{ openIssues }} Open</span>
              <span class="legend-item"><i class="fas fa-circle closed-dot"></i> {{ closedIssues }} Closed</span>
            </div>
            <h4 class="breakdown-title" style="margin-top: 16px;">PR Breakdown</h4>
            <div class="breakdown-bar">
              <div class="bar-segment pr-open"
              [style.width.%]="pullRequests.length ? (openPRs / pullRequests.length) * 100 : 0"></div>
              <div class="bar-segment pr-closed"
              [style.width.%]="pullRequests.length ? (mergedOrClosedPRs / pullRequests.length) * 100 : 0"></div>
            </div>
            <div class="breakdown-legend">
              <span class="legend-item"><i class="fas fa-circle pr-open-dot"></i> {{ openPRs }} Open</span>
              <span class="legend-item"><i class="fas fa-circle pr-closed-dot"></i> {{ mergedOrClosedPRs }}
            Merged/Closed</span>
          </div>
        </div>
      </div>
    </aside>
    <!-- Main Area -->
    <main class="main-area">
      <!-- Toolbar: Tabs + Filters -->
      <div class="toolbar">
        <div class="tabs">
          <button (click)="toggleView('issues')" [class.active]="activeView === 'issues'" class="tab-btn">
            <i class="fas fa-dot-circle"></i>
            <span>Issues</span>
            <span class="badge">{{ filteredIssues.length }}</span>
          </button>
          <button (click)="toggleView('pullRequests')" [class.active]="activeView === 'pullRequests'" class="tab-btn">
            <i class="fas fa-code-branch"></i>
            <span>Pull Requests</span>
            <span class="badge">{{ filteredPullRequests.length }}</span>
          </button>
        </div>
        <div class="filter-controls">
          <div class="filter-dropdown">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" (change)="onStatusFilterChange($event)">
              <option value="">All</option>
              <option value="open">Open</option>
              <option value="merged">Merged</option>
              <option value="closed">Closed</option>
              <option value="draft">Draft</option>
            </select>
          </div>
          <div class="filter-dropdown">
            <label for="repoFilter">Repository</label>
            <select id="repoFilter" (change)="onRepoFilterChange($event)">
              <option value="">All repositories</option>
              @for (repo of uniqueRepositories; track repo) {
                <option [value]="repo">
                  {{ repo }}
                </option>
              }
            </select>
          </div>
          <div class="filter-dropdown">
            <label for="sortBy">Sort By</label>
            <select id="sortBy" (change)="onSortChange($event)">
              <option value="updated-desc">Recently Updated</option>
              <option value="updated-asc">Least Recently Updated</option>
              <option value="created-desc">Newest First</option>
              <option value="created-asc">Oldest First</option>
              <option value="title-asc">Title (A-Z)</option>
              <option value="title-desc">Title (Z-A)</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Issues List -->
      @if (activeView === 'issues') {
        <div class="items-list">
          @for (issue of filteredIssues; track issue) {
            <div class="list-item">
              <div class="item-icon" [ngClass]="issue.closed_at ? 'closed' : 'open'">
                <i [class]="issue.closed_at ? 'fas fa-check-circle' : 'fas fa-dot-circle'"></i>
              </div>
              <div class="item-content">
                <a [href]="issue.html_url" target="_blank" rel="noopener noreferrer" class="item-title">
                  {{ issue.title }}
                </a>
                <span class="item-meta">Updated {{ formatLastUpdated(issue.updated_at) }}</span>
              </div>
            </div>
          }
          @if (filteredIssues.length === 0) {
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No issues found for this contributor</p>
            </div>
          }
        </div>
      }
      <!-- Pull Requests List -->
      @if (activeView === 'pullRequests') {
        <div class="items-list">
          @for (pr of filteredPullRequests; track pr) {
            <div class="list-item">
              <div class="item-icon" [ngClass]="getPrStatusClass(pr)">
                <i [class]="getPrIconClass(pr)"></i>
              </div>
              <div class="item-content">
                <a [href]="pr.html_url" target="_blank" rel="noopener noreferrer" class="item-title">
                  {{ pr.title }}
                </a>
                <span class="item-meta">Updated {{ formatLastUpdated(pr.updated_at) }}</span>
              </div>
            </div>
          }
          @if (filteredPullRequests.length === 0) {
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No pull requests found for this contributor</p>
            </div>
          }
        </div>
      }
    </main>
  </div>
}
</div>